<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper     
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"     
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="handus.dao.AuthorDao">

	<insert id="insertAuction" parameterType="auction">
		<selectKey order="BEFORE" keyProperty="a_pk" resultType="int">
			select AUCTION_SEQ.NEXTVAL from dual
		</selectKey>
		insert all
		
		 into AUCTION
			(A_PK, M_PK_WRITER, A_TITLE, A_STARTPRICE, C_PK, A_STARTTIME,A_ENDTIME,A_COMMENT,A_COUNTRY,A_MATERIAL,A_COLOR,A_SIZE,A_DETAILS)
		values 
		(#{a_pk} ,#{m_pk_writer} ,#{a_title}, #{a_startPrice}, #{c_pk}, #{a_startTime},#{a_endTime} , 
			#{a_comment}, #{a_country}, #{a_material}, #{a_color},#{a_size},#{a_details})
			
		into AUCTION_GRAPH
			(AG_PK, A_PK, M_PK_USER, AG_BIDDING, AG_REGDATE)
		values
		( AUCTION_GRAPH_SEQ.NEXTVAL,#{a_pk} ,#{m_pk_writer}, #{a_startPrice}, #{a_startTime})
		
		select * from dual
	</insert>
	
	<insert id="insertStudio" parameterType="studio">
		<selectKey order="BEFORE" keyProperty="s_pk" resultType="int">
			select STUDIO_SEQ.NEXTVAL from dual
		</selectKey>
		insert into STUDIO
			()
		values ()
	</insert>
	
	<insert id="insertItem" parameterType="item">
		<selectKey order="BEFORE" keyProperty="i_pk" resultType="int">
			select ITEM_SEQ.NEXTVAL from dual
		</selectKey>
		insert into ITEM
			()
		values ()
	</insert>
	
	<insert id="insertImage">
		insert all
		<foreach collection="imgList.imgList" item="item">
		into 
			<if test="type == 'auction'">
				AUCTION_IMAGE
			</if>
			<if test="type == 'item'">
				ITEM_IMAGE
			</if>
			<if test="type == 'studio'">
				STUDIO_IMAGE
			</if>
			values (get_pk_img, #{item.img_fileName}, #{item.img_savePath}, #{item.img_fk}, #{item.img_main})
		</foreach>
		select * from dual
	</insert>
	
	<select id="getListOfAuthor" resultType="map">
		select *
			from 
				<choose>
					<when test="type == 1">
						ITEM
					</when>
					<when test="type == 2">
						AUCTION a join AUCTION_IMAGE ai on (a.a_pk = ai.a_pk and ai.ai_main = 1) 
					</when>
					<when test="type == 3">
						STUDIO
					</when>
				</choose>
			where m_pk_writer = #{m_pk_writer}
	</select>
	
	<insert id="insertAuthor" parameterType="map">
		insert into AUTHOR
			(AT_PK, M_PK, AT_NAME, AT_EMAIL, AT_STUDIO, AT_ADDRESS)
			values	(MEMBER_SEQ.NEXTVAL, #{m_pk}, #{at_name}, #{at_email}, #{at_studio}, #{at_address})
	</insert>
	
	<insert id="insertAuthorImage" parameterType="HashMap">
		<selectKey order="BEFORE" keyProperty="ap_pk"  resultType="int">
			select IMAGE_SEQ.NEXTVAL from dual		
		</selectKey>
		insert into AUTHOR_PROFILE
			(AP_PK, AP_FILENAME, AP_SAVEPATH, M_PK, AP_MAIN)
		values (#{ap_pk}, #{ap_filename}, #{ap_savepath}, #{m_pk}, 1)			
	</insert>
	
	<update id="updateAuthor" parameterType="map">
		
	</update>
	
	<update id="updateAuthorImage" parameterType="map">
		update AUTHOR_PROFILE
			SET AP_MAIN = 0 
				WHERE M_PK = #{m_pk} and ap_pk != #{ap_pk}
	</update>
	
	<select id="selectAuthorImage" parameterType="int" resultType="map">
	 	select ap_filename, ap_savepath
	 		from author_profile
	 			where ap_pk = #{ap_pk}
	</select>
	
	<select id="selectAuthorInfo" parameterType="int" resultType="map">
		select at_pk, at_name, at_email, at_studio, at_address , ap_pk, ap_filename, ap_savepath , at.m_pk as m_pk_writer
			from author at left outer join author_profile ap on (at.m_pk = ap.m_pk and ap.ap_main = 1)
	</select>
</mapper>