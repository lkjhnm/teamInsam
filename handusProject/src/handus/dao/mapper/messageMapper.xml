<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper     
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"     
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="handus.dao.MessageDao">

	<insert id="insertMsgList" parameterType="map">
	<!-- 시퀀스 가져와서, 해당 시퀀스로 pk, num을 세팅하는데 파라미터 타입이 map임 -->
		<selectKey keyProperty="ml_pk" resultType="int">
			select ML_SEQ.NEXTVAL from dual
		</selectKey>
		insert into MESSAGE_LIST
		( ML_PK, ML_NUM, ML_A_PK, ML_M_PK )
		values ( #{ml_pk}, 
			select concat(to_char(sysdate, 'yyyymmdd-'), #{ml_pk}) from dual, 
		  	#{ml_a_pk}, 
		  	#{ml_m_pk} )
	</insert>
	<delete id="deleteMsgList" parameterType="int">
		delete from MESSAGE_LIST 
		where ML_PK = #{ml_pk}
	</delete>
	<select id="getMessageList" parameterType="int">
		select ML_PK, 
		    ML_NUM, 
		    ML_A_PK,
		    ML_M_PK,
		    ML_UPDATE_DATE,
		    (select count(*) from MESSAGE_DETAIL where ML_NUM = MD_ML_NUM) as MSG_COUNT 
		from MESSAGE_LIST
		where ML_NUM = #{ml_num} 
		and ML_M_PK = #{m_pk}
		order by ML_UPDATE_DATE desc 
	</select>
	
	
	<insert id="insertMsgDetail" parameterType="map" >
		<selectKey keyProperty="md_pk" resultType="int">
			select MD_SEQ.NEXTVAL from dual
		</selectKey>
		insert into MESSAGE_DETAIL 
		( MD_PK, MD_WRITER_PK, MD_CONTENT, MD_ML_NUM )
		values ( #{md_pk}, #{writer_pk}, #{content}, #{ml_num} )
	</insert>
	<delete id="deleteMsgDetails" parameterType="int">
		delete from MESSAGE_DETAIL
		where MD_ML_NUM = #{md_ml_num}  
	</delete>
	<select id="getMessages" parameterType="int">
		select MD_PK, 
			MD_WRITER_PK, 
			MD_CONTENT, 
			MD_WRITEDATE, 
			MD_ML_NUM
		from MESSAGE_DETAIL 
		where MD_ML_NUM = #{md_ml_num}
		order by MD_WRITEDATE desc 
	</select>
	
</mapper>